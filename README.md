# sdp-static-website-template
A template python static website using the ONS design system

## Prerequisites

Before continuing, install the following tools:

[**Homebrew**](https://brew.sh/): Follow the instructions on this page

[**Python**](https://www.python.org/downloads/macos/): To install the correct version of python on your local system, check the pyproject.toml and then install the relevant version.

You will need to install [poetry](https://python-poetry.org/docs/#installing-with-the-official-installer) to install the python dependencies. If you want to manage multiple versions of python you will need to install `pyenv`.

Refer to the [confluence page](https://confluence.ons.gov.uk/display/ESD/Guide+on+using+pipenv%2C+pyenv+and+venv) for guidance on installing and using pyenv.

You will also need to have installed [wget](https://formulae.brew.sh/formula/wget) to fetch the `ONS Design System`.

## Build and Deploy

### Fetch the ONS Design System

Download the release of the ONS Design System, and unpack them into the correct location with this command:

```bash
./get_design_system.sh
```

## Make the site

You will need to install the python dependencies, including `Frozen-Flask`, the static website generator:

```bash
poetry install
```

You can activate your virtual environment with the following command:

```bash
poetry shell
```

With Jsonnet content in the content/ directory, you should now be able to run the Flask demo server:

```bash
poetry run flask --app static_website_builder --debug run
```

If everything runs without errors, you should now be able to navigate to [http://127.0.0.1:5000/](http://127.0.0.1:5000/) to view the site.

## Linters & Security Scan

To run the linters (`Pylint & Flake8`) and security scan (`Bandit`):

```bash
sudo ./run_py_tools.sh
```

## Generating different versions of the website

Currently there are three versions of the website that can be built. 
1. Only standard markdown created manually, stored within the Content folder of the repo.
2. Only markdown created using Mkdocs, allowing manual and autogenerated documentation from within the repo and external sources
3. A combination of both.

To run either the Mkdocs or combination version of the website first run:
```bash
./generate_mk_docs.sh
```
This will run mkdocs and generate all of its content, as well as move the created content into the relevant areas of the repo in order to render them within the website.
To set the version of the website you want go to:
./config/website_config.json
and edit "content_type": to equal of the following:

1. "manual_website_only"
2. "mkdocs_website_only"
3. "full_website"

once this is done when you run the website it will build for the appropriate content type.


## Troubleshooting

### Access denied message when trying to reach CloudFront URL

- One common cause of this error message is not having uploaded your site yet.
- Are you coming from a non-UK IP address, possibly due to a VPN being active? If so, switch this off and try again. Geographical restrictions are in place.

If you have any errors running the web app or any other errors, it maybe because of issues relating to your latest macOS version and Xcode command line tools installed. You can try the command below where you will remove and reinstall Xcode command line tools:

```bash
sudo rm -rf /Library/Developer/CommandLineTools
xcode-select --install
/usr/bin/xcodebuild -version
```

If you experience any problems launching the application check the version of macOS installed, as problems can arise if you are using macOS Monterey and following versions uses port 5000 for its control center causing a conflict.

If another program is already using port 5000, you may see the error ```OSError: [Errno 98] or OSError: [WinError 10013]``` when the server tries to start.

In this case run the following command, replacing it with the port you want the web app to run on, so that the application is launched on a different port.

```bash
poetry run flask --app static_website_builder --debug run --port=8000
```

### Working with mkdocs

A common issue when creating documentation with Mkdocs in this format is that Mkdocs also uses Jinja with its own styling guide using Material.
This repo takes the normal Material styling guide and limits it a more bare-bones html body that can then be inserted into the webpages of the SML builder.
However this does mean that it uses its own CSS styleguide and on occasion this can cause conflicts with the CSS in the Static_Website_builder.

Using Inspect Element you can track down when this is happening and make corrections to the mkdocs css file as necessary
